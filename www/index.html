<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Uccello di Fuoco - AUDIO FIXED</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        /* --- PALETTE E COLORI --- */
        :root {
            --bg-main-start: #1a0505; --bg-main-end: #3e1208;
            --container-bg: #000;

            /* Sfondi Gioco */
            --sky-fire: linear-gradient(to bottom, #4a1e11 0%, #2a0a0a 80%, #000000 100%);
            --sky-blue: linear-gradient(to bottom, #0288d1 0%, #01579b 80%, #000000 100%);
            --sky-garden: linear-gradient(to bottom, #0097a7 0%, #006064 100%);

            --accent-gold: #ffd700; --text-light: #ffffff;
            --ui-border: #ff4500;
        }

        * {box-sizing: border-box;margin: 0;padding: 0;font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; user-select: none;}

        body {
            background: #111;
            color: var(--text-light); display: flex; justify-content: center; align-items: center;
            min-height: 100vh; overflow: hidden; touch-action: none; margin: 0;
        }

        /* Contenitore principale */
        .game-wrapper {
            background: var(--container-bg);
            width: 100%; max-width: 480px; height: 100vh;
            position: relative;
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- SCHERMATA DI CARICAMENTO --- */
        .loading-screen {
            position: absolute; inset: 0;
            background: linear-gradient(to bottom, #0a4e2a, #1b5e20); /* Verde Scuro */
            z-index: 9999;
            display: none;
            flex-direction: column; justify-content: space-between; align-items: center;
            padding: 50px 20px;
            text-align: center;
        }

        .loading-quote-top {
            font-family: 'Lora', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
            max-width: 90%;
            line-height: 1.3;
        }

        .loading-center-content {
            width: 100%;
            display: flex; flex-direction: column; align-items: center;
            gap: 15px;
            margin-bottom: 50px;
        }

        .loading-bar-container {
            width: 85%; height: 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            position: relative;
            overflow: visible;
        }

        .loading-bar-fill {
            height: 100%; width: 0%; background: #4caf50;
            border-radius: 10px; transition: width 0.1s linear;
        }

        .loading-bird {
            position: absolute; top: -35px; left: 0%; width: 45px; height: 45px;
            background-image: url('bird-sprite-removebg-preview.png');
            background-size: 200% 200%; background-repeat: no-repeat; background-position: 0% 0%;
            transform: translateX(-50%);
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));
            animation: fly-cycle 0.3s steps(1) infinite;
            transition: left 0.1s linear;
        }

        .loading-quote-bottom {
            font-family: 'Fredoka One', cursive;
            font-size: 1.3rem;
            color: #81c784;
        }

        .loading-logo {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5rem;
            color: #fdd835;
            text-shadow: 2px 2px 0px #5d4037;
            display: flex; align-items: center; gap: 10px;
        }
        .loading-logo::before {
            content: 'üÄÑ'; font-size: 2rem;
        }

        /* --- UI DI GIOCO --- */
        .header {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 20; pointer-events: none;
        }
        .header-right { display: flex; gap: 10px; align-items: center; pointer-events: auto; }

        .score {
            font-size: 1.2rem; padding: 5px 15px; border-radius: 999px;
            background: rgba(0,0,0,0.6); border: 2px solid rgba(255, 255, 255, 0.3);
            text-shadow: 1px 1px 2px black;
        }
        .score span {font-weight: 800; color: var(--accent-gold);}
        .gen-counter { font-size: 0.8rem; margin-left: 5px; color: #39ff14; }

        .mute-btn { background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; color: #fff; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }

        /* --- AREA DI GIOCO --- */
        .game-area {
            position: absolute; inset: 0;
            overflow: hidden;
            background: var(--sky-fire);
            touch-action: none; cursor: grab;
            transition: background 1.5s ease;
        }
        .game-area:active { cursor: grabbing; }

        /* --- SCENARIO CUTSCENE --- */
        .scene-container { position: absolute; bottom: 0; left: 0; right: 0; height: 100%; pointer-events: none; display: none; z-index: 8; }
        .tree-trunk { position: absolute; bottom: 0; right: 20%; width: 60px; height: 400px; background: linear-gradient(to right, #3e2723, #5d4037); border-radius: 10px 10px 0 0; }
        .branch { position: absolute; bottom: 250px; right: 20%; width: 150px; height: 20px; background: #5d4037; transform: rotate(-10deg); border-radius: 10px; }
        .nest { position: absolute; bottom: 265px; right: 45%; width: 80px; height: 40px; background: #8d6e63; border-radius: 0 0 40px 40px; border: 4px solid #5d4037; z-index: 9; overflow: visible; }
        .eggs-container { position: absolute; top: -15px; left: 15px; display: flex; gap: 2px; }
        .egg { width: 15px; height: 20px; background: #fff8e1; border-radius: 50%; border: 1px solid #d7ccc8; }
        .leaf { position: absolute; background: rgba(46, 125, 50, 0.9); border-radius: 50%; }

        /* --- PLAYER --- */
        .player {
            position: absolute; width: 90px; height: 90px;
            background-image: url('bird-sprite-removebg-preview.png');
            background-size: 200% 200%; background-repeat: no-repeat; background-position: 0% 0%;
            background-color: transparent; left: 50%; top: 380px; z-index: 10;
            animation: fly-cycle 0.4s steps(1) infinite;
            transition: transform 0.1s, filter 0.3s ease;
            filter: sepia(100%) saturate(2000%) hue-rotate(20deg) brightness(120%);
            pointer-events: none;
        }
        .player.super-mode { filter: sepia(100%) saturate(2500%) hue-rotate(-60deg) brightness(1.1) contrast(150%) !important; }
        .player.ultra-mode { filter: sepia(100%) saturate(800%) hue-rotate(70deg) brightness(1.5) contrast(130%) !important; z-index: 12; }
        .player.landing { animation: fly-cycle 0.2s steps(1) infinite; filter: none !important; transform: scale(0.6) !important; transition: left 2s, top 2s; }
        .player.incubating { animation: happy-bounce 0.5s infinite alternate !important; filter: none !important; transform: scale(0.7) !important; transition: left 2s, top 2s; }
        @keyframes happy-bounce { from { margin-top: 0; } to { margin-top: -10px; } }

        .carried-baby {
            position: absolute; top: -15px; left: 25%; width: 45px; height: 45px;
            background-image: url('bird-sprite-removebg-preview.png'); background-size: 200% 200%; background-repeat: no-repeat;
            display: none; z-index: 11;
        }

        .companion {
            position: absolute; width: 60px; height: 60px;
            background-image: url('bird-sprite-removebg-preview.png');
            background-size: 200% 200%; background-repeat: no-repeat; background-position: 0% 0%;
            z-index: 9; animation: fly-cycle 0.3s steps(1) infinite;
            transition: transform 0.2s, filter 0.3s ease; display: none;
            filter: sepia(100%) saturate(2000%) hue-rotate(20deg) brightness(120%);
            pointer-events: none;
        }
        .companion.ultra-mode { filter: sepia(100%) saturate(800%) hue-rotate(70deg) brightness(1.5) contrast(130%); }

        @keyframes fly-cycle { 0% { background-position: 0% 0%; } 33% { background-position: 0% 100%; } 66% { background-position: 100% 100%; } 100% { background-position: 0% 0%; } }
        .player.dead { animation-play-state: paused; filter: grayscale(100%) brightness(0.4) contrast(1.2) !important; }

        /* --- TESCHI E BOMBE --- */
        .obstacle {
            position: absolute; width: 90px; height: 100px;
            background-image: url('fire-36.gif');
            background-size: 100% 100%; background-repeat: no-repeat; background-position: center;
            mix-blend-mode: screen; z-index: 5;
        }
        .obstacle.orange { filter: brightness(1.3) saturate(1.5); }
        .obstacle.bordeaux { filter: hue-rotate(280deg) brightness(1.2) saturate(3); }
        .obstacle.green { filter: hue-rotate(80deg) brightness(1.4) saturate(2.5); }
        .obstacle.darkred { filter: sepia(1) saturate(6) hue-rotate(-20deg) brightness(0.9); }

        .obstacle.bomb {
            filter: grayscale(100%) brightness(0.8) contrast(1.5);
            z-index: 6; animation: bomb-pulse 0.4s infinite alternate;
        }
        .obstacle.bomb::before {
            content: ''; position: absolute; top: -15px; left: 50%; width: 4px; height: 15px;
            background: #8d6e63; transform: translateX(-50%) rotate(-10deg); border-radius: 2px; z-index: 7; border: 1px solid #fff;
        }
        .obstacle.bomb::after {
            content: ''; position: absolute; top: -28px; left: 48%; width: 14px; height: 14px;
            background: radial-gradient(circle, #ffffff, #ffff00, #ff0000); border-radius: 50%;
            transform: translateX(-50%); z-index: 8; box-shadow: 0 0 10px #ffff00;
            animation: fuse-burn 0.1s infinite alternate;
        }
        @keyframes bomb-pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        @keyframes fuse-burn { 0% { transform: translateX(-50%) scale(1); opacity: 0.8; } 100% { transform: translateX(-50%) scale(1.5); opacity: 1; } }

        .coin { position: absolute; width: 42px; height: 42px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #ffffff, #ffd700, #ff8c00); border: 3px solid #b8860b; box-shadow: 0 0 10px rgba(255, 215, 0, 0.8); z-index: 6; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: 900; color: #5c1a0a; animation: spin 1s infinite alternate; text-shadow: 1px 1px 2px rgba(255,255,255,0.5); }
        .coin::after { content: '$'; }
        @keyframes spin { 0% { transform: scale(1); } 100% { transform: scale(1.2); } }

        .flying-nest { position: absolute; width: 70px; height: 40px; background: #8d6e63; border-radius: 0 0 40px 40px; border: 3px solid #5d4037; z-index: 6; display: flex; justify-content: center; align-items: flex-start; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .flying-nest::after { content: 'ü™π'; font-size: 20px; position: absolute; top: -15px; }

        .explosion { position: absolute; width: 120px; height: 120px; background: radial-gradient(circle, #ff4500, #ffcc00, transparent); border-radius: 50%; animation: explode 0.4s forwards; z-index: 15; pointer-events: none; mix-blend-mode: screen; }
        @keyframes explode { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        .explosion.bomb-blast { background: radial-gradient(circle, #ff0000, #000000, transparent); mix-blend-mode: normal; }

        .score-pop { position: absolute; color: var(--accent-gold); font-weight: 900; font-size: 1.6rem; animation: floatUp 0.8s forwards; z-index: 20; pointer-events: none; text-shadow: 0 0 8px #000, 0 0 4px var(--accent-gold); }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }

        /* OVERLAY START */
        .game-over-overlay { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; text-align: center; color: #fff; z-index: 50; }
        .game-over-overlay h2 { font-size: 3rem; color: #ff4500; text-transform: uppercase; text-shadow: 0 0 30px rgba(255,69,0,0.8); margin: 0; }
        .btn { padding: 15px 40px; border-radius: 50px; border: none; background: linear-gradient(to right, #ff4500, #ffd700); color: #4a1e11; font-weight: 900; font-size: 1.5rem; cursor: pointer; box-shadow: 0 0 20px rgba(255, 69, 0, 0.6); text-transform: uppercase; border: 3px solid #ffffff; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .instructions { margin-top: 20px; color: #aaa; font-size: 0.9rem; max-width: 80%; line-height: 1.4; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
<div class="game-wrapper">
    <div class="header" id="gameHeader" style="display:none;">
        <div class="score">
            <span id="levelBadge" style="margin-right:10px; color:cyan;">LV.1</span>
            Score: <span id="score">0</span>
            <span class="baby-counter" id="babyCounter" style="display:none; margin-left:10px;">üê£ 0/3</span>
        </div>
        <div class="header-right">
            <button class="mute-btn" id="muteBtn">üîä</button>
        </div>
    </div>

    <div class="game-area" id="gameArea">
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-quote-top">"protegge la natura per ciclo di vita sano"</div>
            <div class="loading-center-content">
                <div class="loading-bar-container">
                    <div class="loading-bird" id="loadingBird"></div>
                    <div class="loading-bar-fill" id="loadingFill"></div>
                </div>
                <div class="loading-quote-bottom">- vita e amore fano la differenza</div>
            </div>
            <div class="loading-logo">Vita Mahjong</div>
        </div>

        <div class="game-over-overlay" id="startScreen">
            <h2>UCCELLO DI FUOCO</h2>
            <div class="instructions">
                <strong>TRASCINA</strong> per muoverti.<br>
                Evita le bombe nere.<br>
                100pts = Sangue | 1000pts = Gigante
            </div>
            <button class="btn" id="startBtn">INIZIO GIOCO</button>
        </div>

        <div class="scene-container" id="sceneContainer">
            <div class="tree-trunk"></div> <div class="branch"></div>
            <div class="nest"><div class="eggs-container" id="eggs"><div class="egg"></div><div class="egg"></div><div class="egg"></div></div></div>
            <div class="leaf" style="bottom: 350px; right: 15%; width: 100px; height: 100px;"></div>
            <div class="leaf" style="bottom: 380px; right: 25%; width: 80px; height: 80px;"></div>
            <div class="leaf" style="bottom: 320px; right: 5%; width: 90px; height: 90px;"></div>
        </div>

        <div class="player" id="player">
            <div class="carried-baby" id="carriedBaby"></div>
        </div>
        <div class="companion" id="companion1"></div>
        <div class="companion" id="companion2"></div>
    </div>
</div>

<script>
    const gameArea = document.getElementById("gameArea");
    const gameHeader = document.getElementById("gameHeader");
    const playerEl = document.getElementById("player");
    const carriedBaby = document.getElementById("carriedBaby");
    const companion1 = document.getElementById("companion1");
    const companion2 = document.getElementById("companion2");
    const sceneContainer = document.getElementById("sceneContainer");
    const eggsContainer = document.getElementById("eggs");
    const scoreEl = document.getElementById("score");
    const levelBadge = document.getElementById("levelBadge");
    const babyCounter = document.getElementById("babyCounter");
    const startBtn = document.getElementById("startBtn");
    const startScreen = document.getElementById("startScreen");
    const muteBtn = document.getElementById("muteBtn");
    const loadingScreen = document.getElementById("loadingScreen");
    const loadingFill = document.getElementById("loadingFill");
    const loadingBird = document.getElementById("loadingBird");

    // --- AUDIO LOCALE (CORRETTO CON I TUOI NOMI FILE E CARTELLA 'audio') ---
    const audioContext = {
        bg: new Audio('audio/Epoq-Lepidoptera.ogg'),
        crash: new Audio('audio/explosion.mp3'),
        coin: new Audio('audio/week7-brrring.mp3'),
        smash: new Audio('audio/missile.mp3'),
        win: new Audio('audio/week7-brrring.mp3') // Riutilizziamo se non hai un file vittoria specifico
    };

    audioContext.bg.loop = true;
    audioContext.bg.volume = 0.3;
    audioContext.coin.volume = 1.0;

    let isMuted = false;

    function playSound(type) {
        if (isMuted) return;
        // Usa try-catch per evitare blocchi se il file non esiste
        try {
            if (type === 'coin' || type === 'smash') {
                const s = audioContext[type].cloneNode();
                s.volume = audioContext[type].volume;
                s.play().catch(e => { console.log("Audio play error", e); });
            } else {
                audioContext[type].play().catch(e => { console.log("Audio play error", e); });
            }
        } catch(e) { console.log("Audio missing"); }
    }

    function stopMusic() { audioContext.bg.pause(); }

    muteBtn.addEventListener("click", () => {
        isMuted = !isMuted;
        muteBtn.textContent = isMuted ? "üîá" : "üîä";
        if (isMuted) audioContext.bg.pause();
        else if (isRunning) audioContext.bg.play();
    });

    let playerX = 0, playerY = 0;
    let obstacles = [], coins = [], flyingNests = [];
    let lastTimestamp = 0, isRunning = false;
    let score = 0;
    let currentLevel = 1;
    let babiesDelivered = 0;
    const MAX_BABIES = 3;

    let isSuperMode = false, isUltraMode = false;
    let powerEndTime = 0;
    let isEndingSequence = false;
    let isDragging = false;
    let generation = 1;

    let obstacleSpawnTimer = 0, coinSpawnTimer = 0, nestSpawnTimer = 0;
    let facingDirection = 1, fireballImageLoaded = true;

    function setInitialPlayerPosition() {
        const r = gameArea.getBoundingClientRect();
        playerX = r.width/2 - 45; playerY = r.height - 150;
        updatePlayerCSS();

        playerEl.classList.remove('dead', 'super-mode', 'ultra-mode', 'landing', 'incubating');
        playerEl.style.display = 'block';

        if (currentLevel === 2) {
            carriedBaby.style.display = 'block';
            levelBadge.textContent = "LV.2";
            babyCounter.style.display = "inline";
            babyCounter.textContent = `üê£ ${babiesDelivered}/${MAX_BABIES}`;
            gameArea.style.background = "var(--sky-fire)";
            companion1.style.display = 'none';
        } else {
            carriedBaby.style.display = 'none';
            levelBadge.textContent = "LV.1";
            babyCounter.style.display = "none";
            sceneContainer.style.display = 'none';
            eggsContainer.style.opacity = 1;
            gameArea.style.background = "var(--sky-fire)";
        }
    }

    function updatePlayerCSS() {
        playerEl.style.left = playerX + "px";
        playerEl.style.top = playerY + "px";
        let scale = "scale(1)";
        if (isUltraMode) scale = "scale(1.5)";
        else if (isSuperMode) scale = "scale(1.2)";
        playerEl.style.transform = `scaleX(${facingDirection}) ${scale}`;
    }

    function setBlueSky() { gameArea.style.background = "var(--sky-blue)"; }
    function setGardenSky() { gameArea.style.background = "var(--sky-garden)"; }
    function resetBackground() { gameArea.style.background = "var(--sky-fire)"; }

    function activateMode(type) {
        powerEndTime = performance.now() + 10000;
        if (type === 'super') {
            isSuperMode = true; playerEl.classList.add('super-mode'); setBlueSky();
        } else {
            isUltraMode = true; playerEl.classList.add('ultra-mode'); resetBackground();
        }
    }

    function deactivateModes() {
        isSuperMode = false; isUltraMode = false;
        playerEl.classList.remove('super-mode', 'ultra-mode');
        if (!isEndingSequence) resetBackground();
    }

    // --- CARICAMENTO ---
    function startLoadingSequence() {
        startScreen.classList.add('hidden');
        loadingScreen.style.display = "flex";

        // SBLOCCO AUDIO AL CLICK
        playSound('bg'); audioContext.bg.pause();

        let progress = 0;
        const interval = setInterval(() => {
            progress += 1.5;
            loadingFill.style.width = progress + "%";
            loadingBird.style.left = progress + "%";
            if(progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    loadingScreen.style.display = "none";
                    startGame();
                }, 400);
            }
        }, 25);
    }

    function startGame() {
        currentLevel = 1; babiesDelivered = 0; score = 0; scoreEl.textContent = "0";
        obstacles = []; coins = []; flyingNests = [];
        document.querySelectorAll('.obstacle, .coin, .flying-nest, .score-pop').forEach(e => e.remove());

        setInitialPlayerPosition();
        gameHeader.style.display = "flex";

        isSuperMode = false; isUltraMode = false; isEndingSequence = false;
        audioContext.bg.currentTime = 0;
        audioContext.bg.play();
        isRunning = true;
        lastTimestamp = performance.now();
        requestAnimationFrame(gameLoop);
    }

    // --- OGGETTI ---
    function spawnObstacle() {
        const el = document.createElement("div"); el.classList.add("obstacle");
        const rand = Math.random() * 100;
        let type = 'orange', val = 30, bomb = false;

        if ((score > 500 || currentLevel > 1) && rand > 85) {
            bomb = true; type = 'bomb'; val = 0;
        } else {
            if (rand > 90) { type = 'darkred'; val = 120; }
            else if (rand > 70) { type = 'green'; val = 100; }
            else if (rand > 40) { type = 'bordeaux'; val = 60; }
        }
        el.classList.add(type);
        const r = gameArea.getBoundingClientRect();
        const x = Math.random() * (r.width - 90);
        gameArea.appendChild(el);
        el.style.left = x + "px"; el.style.top = "-100px";
        obstacles.push({el, x, y: -100, val, bomb});
    }

    function spawnCoin() {
        const r = gameArea.getBoundingClientRect();
        const startX = Math.random() * (r.width - 140);
        const isHoriz = Math.random() > 0.5;
        for(let i=0; i<3; i++) {
            const el = document.createElement("div"); el.classList.add("coin");
            let cx = isHoriz ? startX + (i*45) : startX;
            let cy = isHoriz ? -50 : -50 - (i*45);
            gameArea.appendChild(el);
            el.style.left = cx+"px"; el.style.top = cy+"px";
            coins.push({el, x: cx, y: cy});
        }
    }

    function spawnNest() {
        const el = document.createElement("div"); el.classList.add("flying-nest");
        const r = gameArea.getBoundingClientRect();
        const x = Math.random() * (r.width - 80);
        gameArea.appendChild(el);
        el.style.left = x+"px"; el.style.top = "-50px";
        flyingNests.push({el, x, y: -50});
    }

    function showExplosion(x, y, isGiant, isBomb) {
        const ex = document.createElement("div"); ex.classList.add("explosion");
        if(isBomb) ex.classList.add("bomb-blast");
        if(isGiant) ex.style.transform = "scale(1.5)";
        ex.style.left = x + "px"; ex.style.top = y + "px";
        gameArea.appendChild(ex);
        setTimeout(() => ex.remove(), 400);
    }

    function checkCol(el1, el2) {
        const r1 = el1.getBoundingClientRect();
        const r2 = el2.getBoundingClientRect();
        const p = 15;
        return !(r1.right-p < r2.left || r1.left+p > r2.right || r1.bottom-p < r2.top || r1.top+p > r2.bottom);
    }

    function triggerLevel1Ending() {
        isEndingSequence = true; isRunning = false; stopMusic(); playSound('win');
        obstacles.forEach(o => o.el.remove()); coins.forEach(c => c.el.remove());
        deactivateModes();
        setGardenSky();
        sceneContainer.style.display = 'block';
        const r = gameArea.getBoundingClientRect();
        playerEl.classList.add('landing');
        playerEl.style.left = (r.width * 0.55 - 45) + "px";
        playerEl.style.top = (r.height - 330) + "px";
        setTimeout(() => {
            playerEl.classList.remove('landing'); playerEl.classList.add('incubating');
            playSound('coin');
            setTimeout(() => {
                eggsContainer.style.opacity = 0;
                setTimeout(() => {
                    isEndingSequence = false;
                    currentLevel = 2;
                    setInitialPlayerPosition();
                    audioContext.bg.play(); isRunning = true; lastTimestamp = performance.now();
                    requestAnimationFrame(gameLoop);
                }, 2000);
            }, 3000);
        }, 3000);
    }

    function gameOver(victory) {
        isRunning = false; isDragging = false;
        stopMusic();
        const ov = document.createElement("div"); ov.classList.add("game-over-overlay");
        if (victory) {
            playSound('win');
            ov.innerHTML = `<h2>VITTORIA!</h2><div style="color:white; font-size:1.2rem">Hai salvato la natura!</div><br><button class="btn" id="restart">RITORNA</button>`;
        } else {
            playerEl.classList.add('dead'); playSound('crash');
            ov.innerHTML = `<h2>GAME OVER</h2><div>Score: <strong>${Math.floor(score)}</strong></div><button class="btn" id="restart">INIZIO GIOCO</button>`;
        }
        gameHeader.style.display = "none";
        gameArea.appendChild(ov);
        document.getElementById("restart").onclick = () => {
            ov.remove();
            startLoadingSequence();
        };
    }

    function gameLoop(ts) {
        if(!isRunning) return;
        const dt = ts - lastTimestamp; lastTimestamp = ts;

        if (currentLevel === 1 && score >= 3000 && !isEndingSequence) { triggerLevel1Ending(); return; }
        if ((isSuperMode || isUltraMode) && ts > powerEndTime) deactivateModes();
        if (currentLevel === 1 && !isSuperMode && !isUltraMode) {
            if (score >= 1000 && score % 1000 < 50) activateMode('ultra');
            else if (score >= 100 && score % 200 < 30) activateMode('super');
        }

        const dy = (200 + score * 0.1) * dt / 1000;

        for (let i = obstacles.length - 1; i >= 0; i--) {
            let o = obstacles[i]; o.y += dy; o.el.style.top = o.y + "px";
            if (o.y > window.innerHeight) { o.el.remove(); obstacles.splice(i, 1); continue; }
            if (checkCol(playerEl, o.el)) {
                if (o.bomb) { gameOver(false); return; }
                if (isSuperMode || isUltraMode) {
                    playSound('smash'); o.el.remove(); obstacles.splice(i, 1);
                    score += o.val; scoreEl.textContent = score;
                    showExplosion(o.x, o.y, isUltraMode, false);
                } else { gameOver(false); return; }
            }
        }

        for (let i = coins.length - 1; i >= 0; i--) {
            let c = coins[i]; c.y += dy; c.el.style.top = c.y + "px";
            if (c.y > window.innerHeight) { c.el.remove(); coins.splice(i, 1); continue; }
            if (checkCol(playerEl, c.el)) {
                playSound('coin'); score += 50; scoreEl.textContent = score;
                c.el.remove(); coins.splice(i, 1);
            }
        }

        if (currentLevel === 2) {
            for (let i = flyingNests.length - 1; i >= 0; i--) {
                let n = flyingNests[i]; n.y += dy; n.el.style.top = n.y + "px";
                if (n.y > window.innerHeight) { n.el.remove(); flyingNests.splice(i, 1); continue; }
                if (checkCol(playerEl, n.el)) {
                    playSound('win'); n.el.remove(); flyingNests.splice(i, 1);
                    babiesDelivered++; babyCounter.textContent = `üê£ ${babiesDelivered}/${MAX_BABIES}`;
                    if (babiesDelivered >= MAX_BABIES) { gameOver(true); return; }
                }
            }
        }

        obstacleSpawnTimer += dt; if(obstacleSpawnTimer > 1200) { obstacleSpawnTimer = 0; spawnObstacle(); }
        coinSpawnTimer += dt; if(coinSpawnTimer > 2000) { coinSpawnTimer = 0; spawnCoin(); }
        if (currentLevel === 2) { nestSpawnTimer += dt; if(nestSpawnTimer > 4000) { nestSpawnTimer = 0; spawnNest(); } }

        requestAnimationFrame(gameLoop);
    }

    function showScorePop(x, y, amount, style) {
        const pop = document.createElement("div"); pop.classList.add("score-pop");
        if(style === "green") { pop.style.color = "#39ff14"; pop.style.textShadow = "0 0 10px #39ff14"; }
        pop.textContent = `+${amount}`; pop.style.left = x + "px"; pop.style.top = y + "px";
        gameArea.appendChild(pop); setTimeout(() => pop.remove(), 800);
    }

    function moveP(e) {
        if(isEndingSequence) return;
        const r = gameArea.getBoundingClientRect();

        // Supporto Touch/Mouse
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        let nx = clientX - r.left - 45;
        let ny = clientY - r.top - 45;

        if (nx < playerX) facingDirection = -1; else facingDirection = 1;
        playerX = Math.max(0, Math.min(r.width - 90, nx));
        playerY = Math.max(0, Math.min(r.height - 90, ny));
        updatePlayerCSS();
    }

    // LISTENER UNIFICATI (PC e Mobile)
    gameArea.addEventListener('mousedown', (e) => {
        if(isRunning && !isEndingSequence) { isDragging = true; moveP(e); }
    });
    window.addEventListener('mousemove', (e) => {
        if(isRunning && isDragging) { e.preventDefault(); moveP(e); }
    });
    window.addEventListener('mouseup', () => isDragging = false);

    // TOUCH EVENTS
    gameArea.addEventListener('touchstart', (e) => {
        if(isRunning && !isEndingSequence) { isDragging = true; moveP(e); }
    }, {passive: false});
    window.addEventListener('touchmove', (e) => {
        if(isRunning && isDragging) { e.preventDefault(); moveP(e); }
    }, {passive: false});
    window.addEventListener('touchend', () => isDragging = false);

    startBtn.addEventListener("click", startLoadingSequence);

    window.addEventListener("load", () => {
        const i = new Image(); i.src='bird-sprite-removebg-preview.png';
    });
</script>
</body>
</html>